<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVTOTO PRO | Dashboard Monitoring Saldo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap');
        
        :root { --primary: #6366f1; --dark: #0f172a; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .table-container { height: calc(100vh - 380px); overflow-y: auto; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .status-pulse { animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        
        /* Filter Button Active */
        .filter-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body class="text-slate-900">

    <div class="flex h-screen overflow-hidden">
        <aside class="w-72 bg-[#0f172a] text-white p-8 hidden lg:flex flex-col shadow-2xl">
            <div class="mb-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-500 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-layer-group text-white"></i>
                    </div>
                    <h1 class="text-2xl font-extrabold tracking-tighter italic">TVTOTO<span class="text-indigo-400">PRO</span></h1>
                </div>
                <p class="text-[9px] uppercase tracking-[0.4em] font-bold text-slate-500 mt-4 leading-relaxed">Financial Monitoring v3.0</p>
            </div>

            <nav class="space-y-6 flex-1">
                <div>
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 block">Connection</label>
                    <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700">
                        <div class="flex justify-between items-center mb-1">
                            <span id="statusText" class="text-xs font-bold text-yellow-500 italic">Syncing...</span>
                            <div id="statusDot" class="h-2 w-2 rounded-full bg-yellow-500"></div>
                        </div>
                        <p id="syncTime" class="text-[10px] mono text-slate-400">--:--:--</p>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 block">Quick Filter</label>
                    <div id="filterContainer" class="flex flex-wrap gap-2">
                        <button onclick="filterByBank('ALL')" class="filter-btn active px-3 py-1.5 rounded-lg border border-slate-700 text-[10px] font-bold transition-all hover:bg-slate-700">ALL</button>
                        <button onclick="filterByBank('BCA')" class="filter-btn px-3 py-1.5 rounded-lg border border-slate-700 text-[10px] font-bold transition-all hover:bg-slate-700">BCA</button>
                        <button onclick="filterByBank('MANDIRI')" class="filter-btn px-3 py-1.5 rounded-lg border border-slate-700 text-[10px] font-bold transition-all hover:bg-slate-700">MANDIRI</button>
                        <button onclick="filterByBank('BRI')" class="filter-btn px-3 py-1.5 rounded-lg border border-slate-700 text-[10px] font-bold transition-all hover:bg-slate-700">BRI</button>
                    </div>
                </div>
            </nav>

            <div class="pt-6 border-t border-slate-800">
                <button onclick="ambilDataSaldo()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl transition shadow-lg active:scale-95 flex items-center justify-center gap-2">
                    <i class="fas fa-sync-alt"></i> SINKRONISASI
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto p-4 lg:p-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="glass-card p-6 rounded-[2rem] shadow-sm flex items-center gap-5">
                    <div class="bg-indigo-100 text-indigo-600 w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-inner">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">Total Saldo Terbaca</p>
                        <h3 id="totalSaldo" class="text-2xl font-extrabold mono tracking-tighter text-indigo-600">Rp 0</h3>
                    </div>
                </div>
                
                <div class="glass-card p-6 rounded-[2rem] shadow-sm flex items-center gap-5">
                    <div class="bg-emerald-100 text-emerald-600 w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-inner">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">Rekening Terpantau</p>
                        <h3 id="totalBank" class="text-2xl font-extrabold mono tracking-tighter text-emerald-600">0</h3>
                    </div>
                </div>

                <div class="flex items-center">
                    <button onclick="toggleModal()" class="w-full py-5 bg-slate-900 text-white rounded-[1.5rem] font-bold hover:bg-indigo-600 transition-all flex items-center justify-center gap-3 shadow-xl">
                        <i class="fas fa-plus-circle"></i> TAMBAH AKUN
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-xl border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md sticky top-0 z-20 flex flex-wrap gap-4 justify-between items-center">
                    <div class="relative w-full md:w-96">
                        <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Cari nama atau nomor rekening..." 
                        class="w-full pl-12 pr-6 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition font-medium">
                    </div>
                    <div id="activeFilterLabel" class="text-[10px] font-black px-4 py-2 bg-slate-100 rounded-full text-slate-500">FILTER: SEMUA DATA</div>
                </div>

                <div class="table-container custom-scroll">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50/80 sticky top-0 z-10">
                            <tr class="text-[10px] font-black uppercase text-slate-400 tracking-widest">
                                <th class="p-6 border-b">Provider</th>
                                <th class="p-6 border-b">Informasi Akun</th>
                                <th class="p-6 border-b text-right">Saldo Saat Ini</th>
                                <th class="p-6 border-b text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-100">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-md shadow-2xl scale-up-animation">
            <h2 class="text-2xl font-black mb-2 text-slate-800">Akun Baru</h2>
            <p class="text-xs text-slate-400 mb-8 font-medium">Input nama harus persis dengan Google Sheets</p>
            
            <div class="space-y-4">
                <input type="text" id="inBank" placeholder="BANK (Contoh: BCA, MANDIRI)" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 font-bold uppercase text-xs outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="text" id="inRek" placeholder="NOMOR REKENING" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 font-bold mono text-xs outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="text" id="inNama" placeholder="NAMA LENGKAP" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 font-bold text-xs uppercase outline-none focus:ring-2 focus:ring-indigo-500">
                
                <div class="flex gap-3 pt-6">
                    <button onclick="simpanData()" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-600/20 hover:bg-indigo-700 transition">SIMPAN</button>
                    <button onclick="toggleModal()" class="flex-1 bg-slate-100 text-slate-400 py-4 rounded-xl font-bold hover:bg-slate-200 transition">BATAL</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sheetCSVUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSsnosH5qmA4ADdf2nPeM7k1JdZI-RDhgA4Y8GgSmB5Qs-9MCaaEdeykDzRGFjjcrjhotKKSyd5J_D0/pub?gid=1655913458&single=true&output=csv';
        const soundAlert = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        
        let dataBank = [];
        let currentFilter = 'ALL';
        let totalSaldoLama = 0;

        // Inisialisasi Data dari Storage atau Default
        function initData() {
            const saved = localStorage.getItem('tvtoto_monitor_v3');
            if (saved) {
                dataBank = JSON.parse(saved);
            } else {
                dataBank = [
                    { bank: "OCBC", norek: "621810071939", nama: "RAISAH BT RALI", saldo: 0 },
                    { bank: "OCBC", norek: "624810073756", nama: "JERRY RAND", saldo: 0 },
                    { bank: "SINARMAS", norek: "0059567365", nama: "RAISAH BT RALI", saldo: 0 },
                    { bank: "BCA", norek: "1940533356", nama: "BILLY TANJUNG KURNIAWAN", saldo: 0 }
                ];
                saveToStorage();
            }
            renderTable();
            ambilDataSaldo();
        }

        async function ambilDataSaldo() {
            updateStatus("loading");
            try {
                const res = await fetch(`${sheetCSVUrl}&t=${Date.now()}`);
                const csv = await res.text();
                Papa.parse(csv, {
                    complete: (results) => {
                        prosesLogikaSaldo(results.data);
                        updateStatus("online");
                    }
                });
            } catch (err) {
                updateStatus("offline");
            }
        }

        function prosesLogikaSaldo(rows) {
            let totalBaru = 0;
            dataBank.forEach(item => {
                item.saldo = 0;
                // Cari baris yang mengandung nama (case insensitive)
                const row = rows.find(r => 
                    r.some(cell => cell.toString().toUpperCase().trim() === item.nama.toUpperCase().trim())
                );

                if (row) {
                    let numbers = [];
                    row.forEach(cell => {
                        let clean = cell.toString().replace(/[^\d]/g, '');
                        // Angka yang dianggap saldo adalah 4-12 digit & bukan nomor rekening
                        if (clean.length >= 4 && clean.length <= 12 && clean !== item.norek) {
                            numbers.push(parseInt(clean));
                        }
                    });
                    if (numbers.length > 0) {
                        item.saldo = Math.max(...numbers);
                        totalBaru += item.saldo;
                    }
                }
            });

            if (totalBaru > totalSaldoLama && totalSaldoLama !== 0) {
                soundAlert.play().catch(() => {});
            }
            totalSaldoLama = totalBaru;
            renderTable();
        }

        function renderTable() {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';
            
            let filtered = dataBank;
            if (currentFilter !== 'ALL') {
                filtered = dataBank.filter(x => x.bank.toUpperCase() === currentFilter);
            }

            let totalDisplay = 0;
            filtered.forEach((item, index) => {
                totalDisplay += item.saldo;
                body.innerHTML += `
                    <tr class="hover:bg-slate-50 transition-colors group">
                        <td class="p-6">
                            <span class="px-3 py-1 bg-white border border-slate-200 rounded-lg text-[9px] font-black text-slate-600 uppercase tracking-tighter shadow-sm group-hover:border-indigo-200 group-hover:bg-indigo-50 transition-all">${item.bank}</span>
                        </td>
                        <td class="p-6">
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-slate-800 uppercase tracking-tight">${item.nama}</span>
                                <span class="text-[11px] mono text-slate-400 font-medium">${item.norek}</span>
                            </div>
                        </td>
                        <td class="p-6 text-right">
                            <span class="text-base font-bold mono ${item.saldo > 0 ? 'text-emerald-600' : 'text-slate-300'}">
                                ${formatIDR(item.saldo)}
                            </span>
                        </td>
                        <td class="p-6 text-center">
                            <button onclick="hapusAkun(${index})" class="w-8 h-8 rounded-lg text-slate-300 hover:bg-red-50 hover:text-red-500 transition-all active:scale-90 flex items-center justify-center mx-auto">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('totalSaldo').innerText = formatIDR(totalDisplay);
            document.getElementById('totalBank').innerText = filtered.length;
        }

        function filterByBank(bank) {
            currentFilter = bank;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === bank);
            });
            document.getElementById('activeFilterLabel').innerText = `FILTER: ${bank === 'ALL' ? 'SEMUA DATA' : bank}`;
            renderTable();
        }

        function searchTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }

        function simpanData() {
            const b = document.getElementById('inBank').value.toUpperCase();
            const r = document.getElementById('inRek').value;
            const n = document.getElementById('inNama').value.toUpperCase();
            
            if(b && r && n) {
                dataBank.unshift({ bank: b, norek: r, nama: n, saldo: 0 });
                saveToStorage();
                renderTable();
                toggleModal();
                ambilDataSaldo();
                // Clear inputs
                document.getElementById('inBank').value = '';
                document.getElementById('inRek').value = '';
                document.getElementById('inNama').value = '';
            }
        }

        function hapusAkun(i) {
            if(confirm('Hapus akun ini dari monitor?')) {
                dataBank.splice(i, 1);
                saveToStorage();
                renderTable();
            }
        }

        function saveToStorage() { localStorage.setItem('tvtoto_monitor_v3', JSON.stringify(dataBank)); }
        function toggleModal() { document.getElementById('modal').classList.toggle('hidden'); }
        function formatIDR(v) { return "Rp " + new Intl.NumberFormat('id-ID').format(v); }

        function updateStatus(s) {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            const time = document.getElementById('syncTime');
            if(s === "online") {
                dot.className = "h-2 w-2 rounded-full bg-emerald-500 status-pulse";
                txt.innerText = "Sistem Online"; txt.className = "text-xs font-bold text-emerald-500 italic";
                time.innerText = new Date().toLocaleTimeString('id-ID');
            } else if(s === "loading") {
                dot.className = "h-2 w-2 rounded-full bg-yellow-500 animate-pulse";
                txt.innerText = "Sinkronisasi..."; txt.className = "text-xs font-bold text-yellow-500 italic";
            } else {
                dot.className = "h-2 w-2 rounded-full bg-red-500";
                txt.innerText = "Koneksi Gagal"; txt.className = "text-xs font-bold text-red-500 italic";
            }
        }

        // Jalankan
        initData();
        setInterval(ambilDataSaldo, 60000);
    </script>
</body>
</html>
