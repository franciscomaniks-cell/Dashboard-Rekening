<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVTOTO - Monitoring Saldo Full Scan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-100">

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <div class="flex justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">TVTOTO <span class="text-indigo-600">LIVE SCANNER</span></h1>
                <p class="text-slate-500 text-sm">Last Update: <span id="lastUpdate" class="font-mono font-bold">-</span></p>
            </div>
            <div class="text-right">
                <div id="statusTag" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-600">
                    <span class="h-2 w-2 rounded-full bg-yellow-500 mr-2 animate-pulse"></span> MENGHUBUNGKAN...
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-indigo-600 p-6 rounded-3xl text-white shadow-xl shadow-indigo-200">
                <p class="text-indigo-100 text-xs font-bold uppercase tracking-widest">Total Saldo Terdeteksi</p>
                <p id="totalSaldo" class="text-3xl font-black mt-2 text-white">Rp 0</p>
            </div>
            <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Akun Teridentifikasi</p>
                <p id="totalAkun" class="text-3xl font-black mt-2 text-slate-800">0</p>
            </div>
            <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                <div class="relative">
                    <i class="fas fa-search absolute left-0 top-1/2 -translate-y-1/2 text-slate-300"></i>
                    <input type="text" id="searchInput" onkeyup="searchData()" placeholder="Cari nama atau bank..." class="w-full pl-8 outline-none bg-transparent font-semibold text-slate-600">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50 border-b border-slate-100">
                    <tr>
                        <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Informasi Rekening</th>
                        <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Saldo</th>
                    </tr>
                </thead>
                <tbody id="mainTable" class="divide-y divide-slate-50">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSsnosH5qmA4ADdf2nPeM7k1JdZI-RDhgA4Y8GgSmB5Qs-9MCaaEdeykDzRGFjjcrjhotKKSyd5J_D0/pub?gid=1655913458&single=true&output=csv';
        
        let allData = [];

        async function fetchSheet() {
            try {
                const response = await fetch(csvUrl);
                const text = await response.text();
                
                Papa.parse(text, {
                    header: false,
                    complete: function(results) {
                        processLogic(results.data);
                    }
                });
            } catch (error) {
                console.error("Gagal ambil data:", error);
                document.getElementById('statusTag').innerHTML = "ERROR KONEKSI";
            }
        }

        function processLogic(rows) {
            let tempAccounts = [];
            const rowSaldoIndex = 10; // Baris 11 (Saldo)

            if (!rows[rowSaldoIndex]) return;

            // Loop setiap kolom (dari kolom A sampai kolom terakhir yang ada datanya)
            const rowLabelAwal = 1; // Baris 2
            const rowLabelAkhir = 9; // Baris 10

            // Mencari kolom mana saja yang punya data
            const maxCols = rows[rowSaldoIndex].length;

            for (let col = 0; col < maxCols; col++) {
                // 1. Gabungkan label nama dari baris 2-10 di kolom tersebut
                let labelParts = [];
                for (let r = rowLabelAwal; r <= rowLabelAkhir; r++) {
                    if (rows[r] && rows[r][col] && rows[r][col].trim() !== "") {
                        labelParts.push(rows[r][col].trim());
                    }
                }

                let fullLabel = labelParts.join(" ");
                let rawSaldo = rows[rowSaldoIndex][col] || "0";
                
                // Bersihkan angka (hilangkan titik, koma, Rp)
                let cleanSaldo = parseInt(rawSaldo.replace(/[^0-9]/g, '')) || 0;

                // Jika ada label nama, masukkan ke daftar (abaikan kolom kosong)
                if (fullLabel.trim().length > 3) {
                    tempAccounts.push({
                        label: fullLabel,
                        saldo: cleanSaldo,
                        bank: detectBank(fullLabel)
                    });
                }
            }

            allData = tempAccounts;
            renderTable(allData);
            
            // Update UI
            document.getElementById('totalAkun').innerText = allData.length;
            document.getElementById('statusTag').innerHTML = '<span class="h-2 w-2 rounded-full bg-emerald-500 mr-2"></span> DATA TERHUBUNG';
            document.getElementById('statusTag').className = "inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-600";
            document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString('id-ID');
        }

        function detectBank(text) {
            const banks = ["BCA", "BNI", "BRI", "MANDIRI", "DANAMON", "OCBC", "SINARMAS", "CIMB", "MAYBANK"];
            for (let b of banks) {
                if (text.toUpperCase().includes(b)) return b;
            }
            return "BANK";
        }

        function renderTable(data) {
            const tbody = document.getElementById('mainTable');
            tbody.innerHTML = '';
            let grandTotal = 0;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="p-10 text-center text-slate-400">Tidak ada data ditemukan di kolom manapun.</td></tr>';
                return;
            }

            data.forEach(item => {
                grandTotal += item.saldo;
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="p-5">
                            <div class="flex items-center gap-3">
                                <div class="bg-slate-100 text-slate-500 text-[9px] font-black px-2 py-1 rounded uppercase">${item.bank}</div>
                                <div class="font-bold text-slate-700 text-sm uppercase">${item.label}</div>
                            </div>
                        </td>
                        <td class="p-5 text-right font-black text-slate-900">
                            ${formatIDR(item.saldo)}
                        </td>
                    </tr>
                `;
            });

            document.getElementById('totalSaldo').innerText = formatIDR(grandTotal);
        }

        function searchData() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(i => i.label.toLowerCase().includes(q));
            renderTable(filtered);
        }

        function formatIDR(val) {
            return "Rp " + new Intl.NumberFormat('id-ID').format(val);
        }

        // Jalankan
        fetchSheet();
        setInterval(fetchSheet, 30000); // Auto refresh tiap 30 detik
    </script>
</body>
</html>
