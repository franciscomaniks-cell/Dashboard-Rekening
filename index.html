<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>TVTOTO MONITORING</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .row-update { animation: highlight 2s ease-out; }
        @keyframes highlight { from { background: rgba(52, 211, 153, 0.3); } to { background: transparent; } }
        thead th { position: sticky; top: 0; background: rgba(30,41,59,0.9); z-index: 10; }
    </style>
</head>
<body class="p-4">
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6 glass p-6 rounded-2xl">
        <div>
            <h1 class="text-2xl font-bold text-indigo-400">TVTOTO <span class="text-white">ULTRA v6.0</span></h1>
            <p id="status" class="text-xs text-slate-400 font-mono">Menghubungkan ke database...</p>
        </div>
        <div class="text-right">
            <p class="text-xs text-slate-400 uppercase font-bold tracking-widest">Total Asset Seluruh Bank</p>
            <h2 id="totalAll" class="text-3xl font-black text-emerald-400">Rp 0</h2>
        </div>
    </div>

    <div class="mb-4 flex gap-4">
        <input type="text" id="search" placeholder="Cari Nama atau Rekening..." class="flex-1 bg-slate-800 border border-slate-700 p-3 rounded-xl outline-none focus:border-indigo-500">
        <button id="refreshBtn" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-3 rounded-xl font-bold transition">REFRESH DATA</button>
    </div>

    <div class="glass rounded-2xl overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-slate-800/50 text-slate-400 text-xs uppercase tracking-tighter">
                    <th class="p-4">BANK</th>
                    <th class="p-4">REKENING / NAMA</th>
                    <th class="p-4 text-right">SALDO TERDETEKSI</th>
                </tr>
            </thead>
            <tbody id="mainTable" class="divide-y divide-white/5"></tbody>
        </table>
    </div>
</div>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSsnosH5qmA4ADdf2nPeM7k1JdZI-RDhgA4Y8GgSmB5Qs-9MCaaEdeykDzRGFjjcrjhotKKSyd5J_D0/pub?gid=1655913458&single=true&output=csv';
let masterData = [...masterDataOriginal]; // Data master sudah didefinisikan

async function fetchData() {
    const statusEl = document.getElementById('status');
    statusEl.innerText = "Sedang sinkronisasi...";
    try {
        const res = await fetch(CSV_URL + '&cache=' + Math.random());
        const text = await res.text();
        Papa.parse(text, { complete: (results) => processData(results.data) });
    } catch (e) {
        statusEl.innerText = "Koneksi Gagal!";
    }
}

function processData(rows) {
    let grandTotal = 0;
    masterData.forEach(acc => {
        const prevSaldo = acc.saldo;
        const findRow = rows.find(r => {
            const str = r.join(" ").toUpperCase();
            return str.includes(acc.norek) || str.includes(acc.nama.toUpperCase().split('/')[0].trim());
        });
        if (findRow) {
            let possibleSaldos = findRow.map(cell => {
                let clean = cell.toString().replace(/[^0-9]/g, '');
                return clean.length > 2 ? parseInt(clean) : 0;
            }).filter(num => num > 0 && num !== parseInt(acc.norek));
            acc.saldo = possibleSaldos.length > 0 ? possibleSaldos[possibleSaldos.length - 1] : 0;
        }
        if (prevSaldo !== acc.saldo) acc.updated = true;
        grandTotal += acc.saldo;
    });
    renderTable();
    document.getElementById('totalAll').innerText = "Rp " + grandTotal.toLocaleString('id-ID');
    document.getElementById('status').innerText = "Update Terakhir: " + new Date().toLocaleTimeString();
}

function renderTable() {
    const tbody = document.getElementById('mainTable');
    tbody.innerHTML = '';
    const fragment = document.createDocumentFragment();
    masterData.forEach(acc => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/5 transition';
        if(acc.updated) tr.classList.add('row-update');
        tr.innerHTML = `
            <td class="p-4 text-xs font-bold text-indigo-400">${acc.bank}</td>
            <td class="p-4">
                <div class="text-sm font-bold">${acc.nama}</div>
                <div class="text-[10px] text-slate-500 font-mono">${acc.norek}</div>
            </td>
            <td class="p-4 text-right font-mono font-bold ${acc.saldo>0?'text-emerald-400':'text-slate-600'}">
                ${acc.saldo.toLocaleString('id-ID')}
            </td>
        `;
        fragment.appendChild(tr);
        acc.updated = false; // reset
    });
    tbody.appendChild(fragment);
}

document.getElementById('search').addEventListener('input', () => {
    const q = document.getElementById('search').value.toUpperCase();
    document.querySelectorAll('#mainTable tr').forEach(r => {
        r.style.display = r.innerText.toUpperCase().includes(q) ? '' : 'none';
    });
});

document.getElementById('refreshBtn').addEventListener('click', fetchData);

fetchData();
setInterval(fetchData, 30000); // refresh otomatis tiap 30 detik
</script>
</body>
</html>
