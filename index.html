<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVTOTO ULTRA | Precision Monitoring System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --bg-main: #020617;
            --accent: #6366f1;
            --danger: #ef4444;
            --success: #10b981;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-main); 
            color: #f8fafc;
            overflow: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Modern Glassmorphism */
        .glass-panel { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.05); 
        }
        
        .active-glow {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.4);
        }

        .table-scroll { height: calc(100vh - 380px); overflow-y: auto; }
        .table-scroll::-webkit-scrollbar { width: 3px; }
        .table-scroll::-webkit-scrollbar-thumb { background: #334155; }

        @keyframes pulse-border {
            0% { border-color: rgba(16, 185, 129, 0.2); }
            50% { border-color: rgba(16, 185, 129, 0.8); }
            100% { border-color: rgba(16, 185, 129, 0.2); }
        }
        .sync-active { animation: pulse-border 2s infinite; }

        /* Balance Change Highlight */
        .value-up { animation: green-flash 1.5s ease; }
        @keyframes green-flash {
            0% { background: rgba(16, 185, 129, 0); }
            20% { background: rgba(16, 185, 129, 0.2); }
            100% { background: rgba(16, 185, 129, 0); }
        }
    </style>
</head>
<body class="p-4 lg:p-8">

    <div class="max-w-[1600px] mx-auto h-full flex flex-col gap-6">
        
        <header class="flex flex-wrap items-center justify-between gap-6">
            <div class="flex items-center gap-5">
                <div class="relative">
                    <div class="w-14 h-14 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-2xl shadow-indigo-500/40">
                        <i class="fas fa-microchip text-2xl text-white"></i>
                    </div>
                    <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 border-2 border-[#020617] rounded-full"></div>
                </div>
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tighter">TVTOTO <span class="text-indigo-500 underline decoration-indigo-500/30">ULTRA</span></h1>
                    <div class="flex items-center gap-3 mt-1">
                        <span id="statusBadge" class="text-[10px] font-black uppercase tracking-[0.2em] px-2 py-0.5 bg-slate-800 text-slate-400 rounded">Engine: Ready</span>
                        <span id="lastUpdate" class="text-[10px] mono text-slate-500">LAST SYNC: --:--:--</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="glass-panel px-6 py-3 rounded-2xl border-l-4 border-indigo-500">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Global Assets</p>
                    <h2 id="grandTotal" class="text-2xl font-black mono text-white">Rp 0</h2>
                </div>
                <button onclick="toggleModal()" class="h-14 px-8 bg-white hover:bg-indigo-50 text-slate-900 rounded-2xl font-black text-sm transition-all transform active:scale-95 flex items-center gap-3">
                    <i class="fas fa-plus"></i> ADD TERMINAL
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 flex-1 overflow-hidden">
            
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div class="glass-panel rounded-[2rem] p-6">
                    <h3 class="text-xs font-black text-slate-400 uppercase mb-6 tracking-widest flex items-center justify-between">
                        Node Statistics <i class="fas fa-chart-pie text-indigo-500"></i>
                    </h3>
                    <div id="bankDistribution" class="space-y-5">
                        </div>
                </div>

                <div class="glass-panel rounded-[2rem] p-6 flex-1 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-indigo-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <h3 class="text-xs font-black text-slate-400 uppercase mb-6 tracking-widest">System Logs</h3>
                    <div id="logs" class="space-y-3 text-[10px] mono text-slate-500 overflow-y-auto max-h-[200px] custom-scroll">
                        <div>> Initializing precision engine...</div>
                        <div>> Waiting for data stream...</div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 glass-panel rounded-[2.5rem] flex flex-col overflow-hidden active-glow transition-all">
                <div class="p-6 border-b border-white/5 flex flex-wrap items-center justify-between gap-4 bg-white/5">
                    <div class="relative flex-1 max-w-md">
                        <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Cari rekening atau nama..." 
                        class="w-full bg-slate-900/50 border border-white/10 rounded-xl py-3 pl-12 pr-6 text-sm focus:outline-none focus:border-indigo-500 transition">
                    </div>
                    <button onclick="ambilData()" class="px-6 py-3 bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400 rounded-xl font-bold text-xs transition-all flex items-center gap-2">
                        <i class="fas fa-sync"></i> REFRESH STREAM
                    </button>
                </div>

                <div class="table-scroll">
                    <table class="w-full border-collapse">
                        <thead class="sticky top-0 bg-[#0f172a] z-10">
                            <tr class="text-[10px] font-black uppercase text-slate-500 tracking-[0.2em] border-b border-white/5">
                                <th class="p-6 text-left">Node</th>
                                <th class="p-6 text-left">Identity</th>
                                <th class="p-6 text-right">Balance Value</th>
                                <th class="p-6 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-white/[0.02]">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md hidden z-50 flex items-center justify-center p-6">
        <div class="glass-panel rounded-[3rem] p-10 w-full max-w-lg shadow-2xl">
            <h2 class="text-2xl font-black mb-6 flex items-center gap-3">
                <i class="fas fa-plus-circle text-indigo-500"></i> Add New Node
            </h2>
            <div class="space-y-4">
                <input type="text" id="inBank" placeholder="BANK NAME (BCA/BRI/ETC)" class="w-full bg-slate-900 border border-white/10 p-4 rounded-xl font-bold uppercase text-xs outline-none focus:border-indigo-500">
                <input type="text" id="inRek" placeholder="ACCOUNT NUMBER" class="w-full bg-slate-900 border border-white/10 p-4 rounded-xl font-bold mono text-xs outline-none focus:border-indigo-500">
                <input type="text" id="inNama" placeholder="HOLDER NAME (MUST MATCH SHEET)" class="w-full bg-slate-900 border border-white/10 p-4 rounded-xl font-bold text-xs uppercase outline-none focus:border-indigo-500">
                <div class="flex gap-4 pt-4">
                    <button onclick="saveNode()" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-black shadow-lg shadow-indigo-600/20">AUTHORIZE</button>
                    <button onclick="toggleModal()" class="px-8 bg-slate-800 text-slate-400 py-4 rounded-xl font-bold">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSsnosH5qmA4ADdf2nPeM7k1JdZI-RDhgA4Y8GgSmB5Qs-9MCaaEdeykDzRGFjjcrjhotKKSyd5J_D0/pub?gid=1655913458&single=true&output=csv';
        let nodes = [];
        let lastGrandTotal = 0;

        // 1. Core Logic: Precision Parsing
        function parsePrecisionBalance(row, norek) {
            let foundValues = [];
            
            row.forEach(cell => {
                if (!cell) return;
                // Bersihkan teks: hilangkan Rp, titik, koma, spasi
                let cleanValue = cell.toString().replace(/Rp/g, '').replace(/\./g, '').replace(/,/g, '').trim();
                
                // Cari angka murni
                let match = cleanValue.match(/\d+/g);
                if (match) {
                    match.forEach(m => {
                        // Kriteria Saldo: Bukan norek, panjang 4-12 digit
                        if (m !== norek && m.length >= 4 && m.length <= 12) {
                            foundValues.push(parseInt(m));
                        }
                    });
                }
            });

            // Akurasi Tertinggi: Biasanya saldo adalah angka terakhir yang muncul di baris
            return foundValues.length > 0 ? foundValues[foundValues.length - 1] : 0;
        }

        // 2. Data Synchronization
        async function ambilData() {
            updateUIStatus("loading");
            addLog("Syncing with master stream...");

            try {
                const response = await fetch(`${CSV_URL}&t=${Date.now()}`);
                const csvData = await response.text();
                
                Papa.parse(csvData, {
                    complete: (results) => {
                        processResults(results.data);
                        updateUIStatus("online");
                    }
                });
            } catch (error) {
                updateUIStatus("error");
                addLog("Stream error: " + error.message);
            }
        }

        function processResults(rows) {
            let currentGrandTotal = 0;
            
            nodes.forEach(node => {
                const prevSaldo = node.saldo;
                node.saldo = 0;

                // Cari baris berdasarkan Nama (Case Insensitive)
                const targetRow = rows.find(r => 
                    r.some(cell => cell && cell.toString().toUpperCase().trim() === node.nama.toUpperCase().trim())
                );

                if (targetRow) {
                    node.saldo = parsePrecisionBalance(targetRow, node.norek);
                    node.updated = (node.saldo !== prevSaldo);
                }
                currentGrandTotal += node.saldo;
            });

            if (currentGrandTotal > lastGrandTotal && lastGrandTotal !== 0) {
                new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(()=>{});
                addLog("Asset inflow detected!");
            }

            lastGrandTotal = currentGrandTotal;
            renderAll();
        }

        // 3. UI Rendering
        function renderAll() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            let bankCount = {};

            nodes.forEach((node, index) => {
                bankCount[node.bank] = (bankCount[node.bank] || 0) + 1;
                
                tbody.innerHTML += `
                    <tr class="group transition-all ${node.updated ? 'value-up' : ''}">
                        <td class="p-6">
                            <span class="px-3 py-1 bg-indigo-500/10 text-indigo-400 rounded-lg text-[10px] font-black uppercase tracking-tighter border border-indigo-500/20">
                                ${node.bank}
                            </span>
                        </td>
                        <td class="p-6">
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-slate-200 uppercase tracking-tight">${node.nama}</span>
                                <span class="text-[10px] mono text-slate-500">${node.norek}</span>
                            </div>
                        </td>
                        <td class="p-6 text-right">
                            <div class="text-lg font-black mono ${node.saldo > 0 ? 'text-emerald-400' : 'text-slate-700'}">
                                ${formatIDR(node.saldo)}
                            </div>
                        </td>
                        <td class="p-6 text-center">
                            <div class="flex items-center justify-center gap-4">
                                <div class="w-2 h-2 rounded-full ${node.saldo > 0 ? 'bg-emerald-500 shadow-[0_0_8px_#10b981]' : 'bg-slate-700'}"></div>
                                <button onclick="deleteNode(${index})" class="text-slate-600 hover:text-red-500 transition">
                                    <i class="fas fa-trash-alt text-xs"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('grandTotal').innerText = formatIDR(lastGrandTotal);
            renderStats(bankCount);
        }

        function renderStats(counts) {
            const container = document.getElementById('bankDistribution');
            container.innerHTML = '';
            Object.keys(counts).forEach(bank => {
                const percent = (counts[bank] / nodes.length) * 100;
                container.innerHTML += `
                    <div>
                        <div class="flex justify-between text-[10px] font-black text-slate-500 mb-2 uppercase">
                            <span>${bank}</span>
                            <span>${counts[bank]} UNIT</span>
                        </div>
                        <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full bg-indigo-500 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            });
        }

        // 4. Helpers
        function formatIDR(v) { return "Rp " + new Intl.NumberFormat('id-ID').format(v); }
        function toggleModal() { document.getElementById('modal').classList.toggle('hidden'); }
        function addLog(msg) {
            const logBox = document.getElementById('logs');
            logBox.innerHTML = `<div>> ${msg}</div>` + logBox.innerHTML;
        }

        function updateUIStatus(s) {
            const badge = document.getElementById('statusBadge');
            const time = document.getElementById('lastUpdate');
            if(s === "online") {
                badge.innerText = "Engine: Optimized"; badge.className = "text-[10px] font-black uppercase tracking-[0.2em] px-2 py-0.5 bg-emerald-500/10 text-emerald-500 rounded";
                time.innerText = "LAST SYNC: " + new Date().toLocaleTimeString();
            } else if(s === "loading") {
                badge.innerText = "Engine: Syncing..."; badge.className = "text-[10px] font-black uppercase tracking-[0.2em] px-2 py-0.5 bg-indigo-500/10 text-indigo-500 rounded";
            } else {
                badge.innerText = "Engine: Offline"; badge.className = "text-[10px] font-black uppercase tracking-[0.2em] px-2 py-0.5 bg-red-500/10 text-red-500 rounded";
            }
        }

        function saveNode() {
            const b = document.getElementById('inBank').value.toUpperCase();
            const r = document.getElementById('inRek').value;
            const n = document.getElementById('inNama').value.toUpperCase();
            if(b && r && n) {
                nodes.unshift({ bank: b, norek: r, nama: n, saldo: 0 });
                localStorage.setItem('tv_nodes_v5', JSON.stringify(nodes));
                renderAll(); toggleModal(); ambilData();
            }
        }

        function deleteNode(i) {
            if(confirm('Disconnect this terminal?')) {
                nodes.splice(i, 1);
                localStorage.setItem('tv_nodes_v5', JSON.stringify(nodes));
                renderAll();
            }
        }

        function filterTable() {
            const val = document.getElementById('searchInput').value.toLowerCase();
            const tr = document.querySelectorAll('#tableBody tr');
            tr.forEach(r => r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none');
        }

        // Init
        const saved = localStorage.getItem('tv_nodes_v5');
        nodes = saved ? JSON.parse(saved) : [];
        renderAll();
        ambilData();
        setInterval(ambilData, 60000); // Auto-sync every minute
    </script>
</body>
</html>
