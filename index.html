<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVTOTO | Ultimate Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; min-height: 100vh; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .row-hover:hover { background: rgba(99, 102, 241, 0.1); transform: translateX(10px); }
        .modal-show { opacity: 1 !important; visibility: visible !important; pointer-events: auto !important; }
        .balance-font { font-family: 'JetBrains Mono', monospace; }
    </style>
</head>
<body class="p-4 md:p-10">

    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 opacity-0 visibility-hidden pointer-events-none transition-all duration-300 p-4">
        <div class="glass w-full max-w-md rounded-[2.5rem] p-10 border-indigo-500/30 shadow-2xl">
            <h3 class="text-2xl font-extrabold mb-6 italic">TAMBAH <span class="text-indigo-500">REKENING</span></h3>
            <div class="space-y-5">
                <input type="text" id="nama" placeholder="NAMA BANK / PEMILIK" class="w-full bg-slate-900 border border-slate-700 rounded-2xl px-6 py-5 outline-none focus:border-indigo-500 text-white font-bold">
                <input type="number" id="saldo" placeholder="NOMINAL SALDO" class="w-full bg-slate-900 border border-slate-700 rounded-2xl px-6 py-5 outline-none focus:border-indigo-500 text-white font-bold">
                <button onclick="kirimData()" id="btnKirim" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-5 rounded-2xl shadow-lg shadow-indigo-500/20 transition-all active:scale-95">SIMPAN KE DATABASE</button>
                <button onclick="tutupModal()" class="w-full text-slate-500 font-bold text-xs uppercase tracking-widest">Batalkan</button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 mb-12">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-2xl shadow-indigo-500/40">
                    <i class="fas fa-database text-2xl text-white"></i>
                </div>
                <div>
                    <h1 class="text-4xl font-extrabold italic tracking-tighter uppercase">TVTOTO <span class="text-indigo-500">PRO</span></h1>
                    <p id="sync" class="text-[10px] font-black text-slate-500 tracking-[0.2em] uppercase mt-1 italic">Status: Online</p>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="bukaModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-5 rounded-2xl font-black text-xs uppercase tracking-widest transition-all shadow-lg shadow-indigo-500/20">+ Add Account</button>
                <div class="glass px-8 py-4 rounded-2xl border-indigo-500/20">
                    <p class="text-[9px] font-black text-indigo-400 uppercase mb-1">Total Assets</p>
                    <h2 id="grandTotal" class="text-2xl font-extrabold balance-font italic text-white">Rp 0</h2>
                </div>
            </div>
        </header>

        <div class="relative mb-10">
            <i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-slate-600"></i>
            <input type="text" id="cari" onkeyup="filter()" placeholder="Cari data rekening..." class="w-full pl-16 pr-8 py-6 rounded-[2rem] bg-slate-900/50 border border-slate-800 outline-none text-white focus:ring-2 focus:ring-indigo-500/50 transition-all font-bold">
        </div>

        <div class="glass rounded-[3rem] overflow-hidden shadow-2xl border-white/5">
            <div class="grid grid-cols-12 px-10 py-8 bg-indigo-500/5 border-b border-white/5 text-[10px] font-black text-slate-500 uppercase tracking-[0.3em]">
                <div class="col-span-8">Identity Details</div>
                <div class="col-span-4 text-right">Liquidity Status</div>
            </div>
            <div id="display" class="divide-y divide-white/5"></div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSsnosH5qmA4ADdf2nPeM7k1JdZI-RDhgA4Y8GgSmB5Qs-9MCaaEdeykDzRGFjjcrjhotKKSyd5J_D0/pub?gid=1655913458&single=true&output=csv';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw39FKs85E8cudsRLcaNQ3X3TiAfLuG1Kd41uRXoTntzrZRl6SHvEGQVWXnwmnnDRWh8Q/exec';

        let dataUtama = [];

        function bukaModal() { document.getElementById('modal').classList.add('modal-show'); }
        function tutupModal() { document.getElementById('modal').classList.remove('modal-show'); }

        async function kirimData() {
            const nama = document.getElementById('nama').value;
            const saldo = document.getElementById('saldo').value;
            const btn = document.getElementById('btnKirim');

            if(!nama || !saldo) return alert("Lengkapi data!");

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch animate-spin"></i> SAVING...';

            try {
                // Menggunakan metode 'no-cors' agar tidak diblokir browser
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ nama, saldo })
                });
                
                alert("Berhasil! Data telah dikirim ke Google Sheets.");
                tutupModal();
                document.getElementById('nama').value = '';
                document.getElementById('saldo').value = '';
                setTimeout(muatData, 2000); // Reload data setelah kirim
            } catch (e) {
                alert("Gagal koneksi ke server!");
            } finally {
                btn.disabled = false;
                btn.innerText = "SIMPAN KE DATABASE";
            }
        }

        async function muatData() {
            try {
                const res = await fetch(CSV_URL);
                const txt = await res.text();
                Papa.parse(txt, { 
                    header: false, 
                    skipEmptyLines: true, 
                    complete: (res) => olahData(res.data) 
                });
            } catch (e) { console.log("Refresh gagal"); }
        }

        function olahData(baris) {
            let list = []; let total = 0;
            baris.forEach((r, idx) => {
                r.forEach((cell, colIdx) => {
                    let isi = cell ? cell.toString().trim() : "";
                    if (isi.includes('/') || isi.toUpperCase().includes('OCBC') || isi.toUpperCase().includes('KAS')) {
                        let raw = (baris[10] && baris[10][colIdx]) || (baris[idx + 1] && baris[idx + 1][colIdx]) || "0";
                        let val = parseInt(raw.replace(/[^0-9]/g, '')) || 0;
                        if (isi.length > 5 && !list.some(x => x.nama === isi)) {
                            list.push({ nama: isi, saldo: val, bank: deteksi(isi) });
                            total += val;
                        }
                    }
                });
            });
            dataUtama = list.sort((a, b) => b.saldo - a.saldo);
            render(dataUtama);
            document.getElementById('grandTotal').innerText = "Rp " + new Intl.NumberFormat('id-ID').format(total);
            document.getElementById('sync').innerText = "Sync: " + new Date().toLocaleTimeString();
        }

        function render(items) {
            const container = document.getElementById('display');
            container.innerHTML = '';
            items.forEach(i => {
                const nol = i.saldo === 0;
                container.innerHTML += `
                    <div class="grid grid-cols-12 px-10 py-9 row-hover transition-all duration-300 items-center ${nol ? 'opacity-20' : ''}">
                        <div class="col-span-8 flex items-center gap-6">
                            <div class="w-14 h-14 rounded-2xl bg-slate-800 flex items-center justify-center text-[10px] font-black text-indigo-400 border border-white/5">${i.bank.substring(0,3)}</div>
                            <div>
                                <h4 class="text-white font-extrabold uppercase italic tracking-tighter">${i.nama}</h4>
                                <p class="text-[9px] font-black text-slate-500 tracking-widest mt-1">${i.bank} NETWORK</p>
                            </div>
                        </div>
                        <div class="col-span-4 text-right">
                            <p class="text-xl font-bold text-white balance-font leading-none">Rp ${new Intl.NumberFormat('id-ID').format(i.saldo)}</p>
                            <span class="text-[8px] font-black uppercase mt-3 inline-block ${nol ? 'text-slate-600' : 'text-emerald-500'} tracking-widest italic">${nol ? 'Idle' : 'Liquid'}</span>
                        </div>
                    </div>`;
            });
        }

        function deteksi(s) {
            const b = ["BCA", "BRI", "BNI", "MANDIRI", "OCBC", "DANAMON"];
            for (let x of b) { if (s.toUpperCase().includes(x)) return x; }
            return "BANK";
        }

        function filter() {
            const q = document.getElementById('cari').value.toLowerCase();
            render(dataUtama.filter(d => d.nama.toLowerCase().includes(q)));
        }

        muatData();
        setInterval(muatData, 60000);
    </script>
</body>
</html>
